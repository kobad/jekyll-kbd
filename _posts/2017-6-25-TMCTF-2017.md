---
layout: post
title: TMCTF 2017 Writeup
date: 2017-06-25 12:00:12
categories: ctf
---

## Reversing 100
RARファイルが渡されるので解凍.
```
$ unrar e biscuit
```
すると、PEとZipが出てくる。
```
$ file biscuit1 biscuit2
biscuit1: PE32 executable (console) Intel 80386 (stripped to external PDB), for MS Windows
biscuit2: Zip archive data, at least v2.0 to extract
```

biscuit1を解析することで、biscuit2のパスワードが出てくるようだ。
biscuit1を実行すると、`Please find sweets name starting from m for biscuit2`と表示される。

これをふまえて、Ollydbgで実行していくと`macaron`という文字列があったので、これを使ったら解凍でき、３つのファイルが出てきた。
```
$ file biscuit3 biscuit4 biscuit5
biscuit3: JPEG image data, JFIF standard 1.01, aspect ratio, density 1x1, segment length 16, comment: "Optimized by JPEGmini 3.13.3.15 0x411b5876", baseline, precision 8, 150x150, frames 3
biscuit4: ASCII text, with CRLF line terminators
biscuit5: PE32 executable (console) Intel 80386 (stripped to external PDB), for MS Windows
```
まず、biscuit4をみるとFlagのヒントが書かれていて、biscuit3, 5にあるのを繋げるらしい
```
$ cat biscuit4
Please create flag.

hint:

Flag = TMCTF{biscuit3_ biscuit5}
```
biscuit3をbinwalkで見るとZipが隠れているのがわかったので、foremostで展開
```
$ binwalk biscuit3

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
0             0x0             JPEG image data, JFIF standard 1.01
382           0x17E           Copyright string: "Copyright (c) 1998 Hewlett-Packard Company"
14253         0x37AD          Zip archive data, at least v1.0 to extract, compressed size: 5, uncompressed size: 5, name: biscuit.txt
14356         0x3814          End of Zip archive

$ foremost biscuit3
```
出てきたZipを展開するとテキストファイルがあり、その中に１つ目の文字列(cream)があった。
```
$ unzip 00000027.zip
Archive:  00000027.zip
extracting: biscuit.txt
$ cat  biscuit.txt
cream
```

次に、biscuit5をOllydbgでみる.挙動はbiscuit1と似ていたので、違いを見ると`shift_char`という関数があった。

ここにブレークポイントを設定して処理を追っていくと、biscuitの前半５文字`biscu`を`abcdefghijklmnopqrstuvwxyz`となんやかんやして別の文字列にしているっぽい。さらに追っていくと、最終的に、`choux`という文字列が生成された。

ヒントを見ると、`TMCTF{biscuit3_ biscuit5}`とあったので、`TMCTF{cream_ choux}`で送るもダメ

`TMCTF{cream_choux}`で送ってもダメで違うのかと思っているとチームメイトがクリアしていた。

答えは、`TMCTF{choux_cream}`だった。ヒントに騙された...

## Analysis-Offensive-100
`Forensic_Encyption`のマジックナンバーがMZになってるので、PKに直してunzip(ここに最初気付かずチームメイトに教えてもらった. 変えずにunzipするとpcapが展開されない。)

すると
```
file_1(jpeg)
file_2(zip) パスワード付き
file_3(pcap)
```
exiftoolでfile_1を見ると、User Commentに怪しい文字列があった
```
$ exiftool file_1
ExifTool Version Number         : 10.53
File Name                       : file_1
Directory                       : .
File Size                       : 20 kB
File Modification Date/Time     : 2017:05:01 12:40:54+09:00
File Access Date/Time           : 2017:06:25 14:37:28+09:00
File Inode Change Date/Time     : 2017:06:24 23:00:58+09:00
File Permissions                : rw-r--r--
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
Exif Byte Order                 : Big-endian (Motorola, MM)
Image Description               :
X Resolution                    : 72
Y Resolution                    : 72
Resolution Unit                 : inches
Software                        :
Exif Version                    : 0210
Components Configuration        : Y, Cb, Cr, -
User Comment                    : VHVyaW5nX01hY2hpbmVfYXV0b21hdG9u
Exif Image Width                : 753
Exif Image Height               : 417
Compression                     : JPEG (old-style)
Thumbnail Offset                : 332
Thumbnail Length                : 2273
JFIF Version                    : 1.01
Image Width                     : 641
Image Height                    : 417
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:2:0 (2 2)
Image Size                      : 641x417
Megapixels                      : 0.267
Thumbnail Image                 : (Binary data 2273 bytes, use -b option to extract)
```
`VHVyaW5nX01hY2hpbmVfYXV0b21hdG9u`とあり、base64でデコードすると`Turing_Machine_automaton`

これがfile_2(.zip) のパスワードだった。

`$unzip file_2.zip`するもエラーを吐くので、調べると`7z`ならいける

`$ 7z file_2.zip`でパスワードを入力すると展開できた。
key.txtが出てくる.
```
src 192.168.30.211 dst 192.168.30.251
        proto esp spi 0xc300fae7 reqid 1 mode transport
        replay-window 32
        auth hmac(sha1) 0x2f279b853294aad4547d5773e5108de7717f5284
        enc cbc(aes) 0x9d1d2cfa9fa8be81f3e735090c7bd272
        sel src 192.168.30.211/32 dst 192.168.30.251/32
src 192.168.30.251 dst 192.168.30.211
        proto esp spi 0xce66f4fa reqid 1 mode transport
        replay-window 32
        auth hmac(sha1) 0x3bf9c1a31f707731a762ea45a85e21a2192797a3
        enc cbc(aes) 0x886f7e33d21c79ea5bac61e3e17c0422
        sel src 192.168.30.251/32 dst 192.168.30.211/32
```
この情報を使うことでpcapのESPで暗号化されていた部分の中身が見える.

復号方法　- http://saitoh.hatenablog.jp/entry/2014/09/29/022926

すると、通信の中フラグの情報がある。
```
M4 Navy
Reflector:C Thin, beta, I, IV, II (T M J F), Plugboard: L-X/A-C/B-Y

TMCTF{APZTQQHYCKDLQZRG}

APZTQQHYCKDLQZRG is encrypted.
```
ぱっとみエニグマ暗号なので、サイトで復号(http://enigma.louisedade.co.uk/enigma.html)してフラグゲット!

TMCTF{RISINGSUNANDMOON}

![enigma](https://kobad.github.io/images/enigma.png)
