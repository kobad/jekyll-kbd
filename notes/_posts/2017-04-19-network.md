---
layout: post
title: "Network"
date: 2017-04-19 23:00:00 +0900
categories: note
---

# 参考
マスタリングTCP/IP

# OSI参照モデル

1. 物理層
	* ビット列と信号の変換
2. データリンク層
	* 物理層で接続されたノード間でのデータ転送の手段を提供
	* アドレス指定スキーム( MACAdress...) を提供
	* ex) ブリッジ, スイッチ
	* ex) ARCnet, PPP
3. ネットワーク層
	* アドレス管理とルーティング
	* ex) ルータ
	* ex) IP, ICMP, NDP, IGMP, IPSec
4. トランスポート層
	* 宛先アプリケーションに信頼できるデータ転送サービスを提供
	* フロー制御、データ分割、再構築
	* コネクション指向、コネクションレス両方
	* ex) ファイアウォール、プロキシサーバ
	* ex) TCP, UDP, DCCP, SCTP, RSVP
5. セッション層
	* コンピュータ間のセッションを制御
	* 機器間のセッションの確立、管理、切断を行う（適切に）
6. プレゼンテーション層
	* データをアプリケーション層が扱える形式に変換する
	* 変換方法はアプリケーション層のプロトコルに依存
	* 暗号化、復号化も行う
7. アプリケーション層
	* インターフェース
	* ex) DHCP, DNS, FTP, HTTP, IMAP...

---
# 概要

## コネクション方式
* コネクション型 - 通信の前後にコネクションの確立と切断を行う。相手が通信不能ならデータを送らずに済む。
* コネクションレス型 - コネクションの確立、切断をしない。いつデータを受信するかわからないので、受け取っていないかを常に確認する必要がある。

## 交換方式
* 回線交換 - 電話。交換機がデータの中継処理を行う。通信相手とコネクションを確立すると切断されるまで占有される。
* パケット交換 - ルータによって通信が結ばれる。ルータに入ってきたパケットはキューを作りながらバッファに格納されて、先に入ってきた順に送信される。バッファがいっぱいになるとパケットを喪失することがある。

## 通信方式
* ユニキャスト - １対１の通信。電話。
* ブロードキャスト - 接続される全ホストへ通信。ブロードキャストドメイン(ブロードキャストできる範囲)
* マルチキャスト - 複数のホストへ通信。ビデオ会議とか。
* エニーキャスト - 複数のホストのうち最適な１つにだけ通信。DNSとか。

## ネットワークの構成機器

### ネットワークインターフェース
コンピュータをネットワークに接続するための機器。NIC。

### リピーター
ネットワークを延長する。

### ブリッジ/レイヤ２スイッチ
データリンク層でネットワーク同士を接続する。データリンクのフレーム（パケット）を認識して、内部メモリに蓄積し相手のネットワークに送出。伝送速度の違うデータリンクでも接続できる。
FCS(Frame Check Sequence)でフレームが正しく届いたかどうかチェックして、壊れたフレームを送信しない。
MACアドレスの学習(一定時間メモリに記憶される)とフィルタリング昨日で無駄なトラフィックを流さない

### ルータ/レイヤ３スイッチ
ネットワーク層の処理。IPアドレスの処理。

### レイヤ4-7スイッチ
トランスポート層からアプリケーション層の情報に基づいて配送処理をする。
通信の優先度を決めてくれる
データ転送の高速化(WANアクセラレータ)、特定アプリケーションの高速化、ファイヤウォールなど

### ゲートウェイ
トランスポート層からアプリケーション層までの階層で、データを変換して中継する。直接通信できない２つの異なるプロトコルの翻訳して通信する。
インターネットの電子メールと携帯電話の電子メールを変換するサービスとか

## インターネット構造

ネットワークは、バックボーン(基幹ネットワーク)とスタブ(末端のネットワーク)から構成され、それぞれはNOCで接続される。

# TCP/IPの階層モデル

1. (ハードウェア)
2. ネットワークインターフェース層(データリンク層)
3. インターネット層(ネットワーク層)
  * IP(Internet Protocol)
  * ICMP(Internet Control Message Protocol)
  * ARP(Address Resolution Protocol)
4. トランスポート層
  * TCP(Transmission Control Protocol)
  * UDP(User Datagram Protocol)
5. アプリケーション層(セッション層以上)
  * WWW
  * E-Mail
  * FTP
  * Telnet, SSH
  * SNMP(Simple Network Management Protocol)
    * ネットワーク管理プロトコル。MIB(Management Information Base)という構造でネットワークインターフェース、パケット量、機器の温度の情報にアクセスできる。
    * ネットワークの混雑具合、障害などの調査になる

## パケットの送信処理1

1. アプリケーションの処理
  * TCPにコネクション確立を指示し、確立したらデータをTCPに渡す
2. TCPモジュールの処理
  * コネクションの確立、切断。データの送信。
3. IPモジュールの処理
  * TCPヘッダとデータのひと塊りを扱う。そのTCPヘッダの前にIPヘッダがつく。IPヘッダには宛先IPアドレスやデータがTCPかUDPなのかといった情報がつく
  * IPパケットができたら、ルーティングテーブルを参照し次のルータかホストに渡す。
  * MACアドレスがわからない時はARPを利用して調べる
4. ネットワークインターフェースの処理
  * イーサネットヘッダには、宛先と送信元のMACアドレス、データのプロトコルを示すサネットタイプが書き込まれる

---

# IPアドレス

IPv4アドレスなら32ビットの整数値
xxx.xxx.xxx.xxx

ネットワーク部とセグメント部に分けられる
* ネットワーク部
  * データリンクのセグメントごとに割り当てられる
* セグメント部(ホスト部)
  * 同一セグメント内で重ならない値

[サブネットマスク計算(IPv4)／サブネット一覧（早見表）](http://note.cman.jp/network/subnetmask.cgi)

## クラス
|クラス|先頭ビット|アドレス範囲|プライベートアドレス|備考|
|-|-|-|-|-|-|-|-|
|A|0|0.0.0.0 - 127.255.255.255|10.0.0.0 ~ 10.255.255.255 (10.0.0.0/8)||
|B|10|128.0.0.0 - 191.255.255.255|172.16.0.0 ~ 172.31.255.255 (172.16.0.0/12)||
|C|110|192.0.0.0 - 223.255.255.255|192.168.0.0 ~ 192.168.255.255 (192.168.0.0/16)||
|D|1110|224.0.0.0 - 239.255.255.255|||||
|E|1111|240.0.0.0 - 255.255.255.255|||||

## その他
### ブロードキャストアドレス

ネットワーク内のすべてのホストにデータ送信する用のアドレス
ホスト部のビットがすべて1になる
通信相手を特定できない場合に使う

* ローカルブロードキャスト
	* 自分の属しているリンク内のブロードキャスト
* ダイレクトブロードキャスト
	* 異なるIPネットワークへのブロードキャスト


### IP マルチキャスト
必要としているグループのみにパケットを送信

### サブネットマスク
どこがネットワーク部とホスト部を定める.
* 1 -> ネットワークアドレス
* 0 -> ホストアドレス
```
IPアドレス: 172.20.100.52
サブネットマスク: 255.255.255.192
```
CIDR表記
```
172.20.100.52 /26
```

### CIDR(Classless Inter-Domain Routing)
[wikipedia](https://ja.wikipedia.org/wiki/Classless_Inter-Domain_Routing)
ルーティングテーブルの肥大化速度を低減させる機構
可変長サブネットマスク (VLSM)」に基づき、プレフィックスを可変長で割り当て可能 -> IPアドレスの枯渇を緩和


### VLSM(Variable Length Subnet Mask)
グループごとにサブネットマスク長が変えられる仕組み

### NAT
プライベートアドレスとグローバルアドレスの変換


# ルーティング

## デフォルトルート
* 0.0.0.0/0
* ルーティングテーブルに登録されてない場合の経路
## ホストルート
* IPAddress/32
* ネットワークインターフェースについてるIPアドレスそのものに基づいて制御
## ループバックアドレス
* 127.0.0.1
* 同じコンピュータ内部で通信したいときに使う

# パケットの分割処理と再構築

* MTU(最大転送単位)はデータリンクによって違う
* 分割処理(フラグメンテーション)

## IP Fragmentation

データを小さく分割して送ることで確実に送信するため

データリンク層のMTU(Maximum Transmission Unit)サイズによって分割サイズが決められる
イーサネット→　１５００

順序
1. データを断片化
2. サイズに合わせてIPヘッダのパケット長を設定
3. 最後のパケット以外のMF(More Fragments)を１にセット
4. フラグメントオフセットを設定
5. 送信


## 経路MTU経路(Path MTU Discovery)

送信先ホストから宛先ホストまで分割処理が必要にならない最大のMTUを見つけて、その大きさに分割して送信する

# IPv4

* バージョン
* ヘッダ長
* サービスタイプ(TOS)
	* トラフィックに優先順位をつけるためにルータが使用するフラグ
* パケット長
	* IPヘッダとデータの長さ
* 識別子
	* パケット、断片化した一連のパケット群を識別する
* フラグ
	* パケットが断片化された一部なのかを識別
* フラグメントオフセット
	* 断片化されている場合正しい順序で並べて復元するため
* 生存時間(TTL)
	* パケットが通過できるルータの数
* プロトコル
	* パケットのタイプの識別
* ヘッダチェックサム
	* IPヘッダが破損していないか
* 送信元IPアドレス
* 宛先IPアドレス
* オプション
	* 追加のオプション。ソースルーティングやタイムスタンプ
* データ
	* 実際のデータ

# IPv6

* 128bit
* 固定長なヘッダ、ヘッダチェックサムを省いて、ルータの負荷を減らす
* ルータに分割処理をさせない
* DHCPサーバがなくても、IPアドレスを自動的に割り当てる
* IPSec

## グローバルユニキャストアドレス
インターネットを介した通信で使う
全世界で一意に決まるアドレス
インターフェースIDにMACアドレスが格納
## ユニークローカルアドレス
プライベートネットワークの時
データリンクの同一リンク内で一意に決まる
インターフェースIDにMACアドレスが格納
## リンクローカルユニキャストアドレス
同一セグメント内だけで通信する時
インターネットとの通信をしないとき

## 分割処理
始点ホストのみで行われる。（ルータが処理しない）
最小MTU = 1280オクテット

チェックサムは省略された

## ヘッダ

* バージョン
* トラフィッククラス
* フローラベル
* ペイロードの長さ
* 次のヘッダ
* ポップリミット
* 送信元IPアドレス
* 宛先IPアドレス
