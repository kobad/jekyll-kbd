---
layout: post
title: T-Pot構築
date:  2017-06-23 00:19:00
categories: security
---

## はじめに
簡単にHoneypot群を作成できるT-Potの紹介.  
前にも別のところでまとめたが、そのアップデート.

VMでもできますが、物理サーバにインストールしています。  
前にやった[発表資料](https://speakerdeck.com/kobad/honey-pot-with-respberry-pi-and-t-pot)


* [はじめに](https://kobadlve.github.io/security/2017/06/23/t-pot.html#はじめに)
* [T-Potとは](https://kobadlve.github.io/security/2017/06/23/t-pot.html#T-Potとは)
* [構成](https://kobadlve.github.io/security/2017/06/23/t-pot.html#構成)
* [導入](https://kobadlve.github.io/security/2017/06/23/t-pot.html#導入)
* [設定](https://kobadlve.github.io/security/2017/06/23/t-pot.html#設定)
* [接続](https://kobadlve.github.io/security/2017/06/23/t-pot.html#接続)
* [まとめ](https://kobadlve.github.io/security/2017/06/23/t-pot.html#まとめ)

## T-Potとは
[T-Pot](http://dtag-dev-sec.github.io/)

T-Potは複数のハニーポットを運用し、それらから得られたログをELK(Elastic-search, Logstash, Kibana)を使って上手く可視化してくれます。

各ハニーポットとツールをDockerで運用し、それぞれのログを集めてまとめて可視化しています。

![tpot](http://dtag-dev-sec.github.io/assets/images/tpot.png)

## 構成
基本7つのハニーポットと可視化ツールが動いています。

* [Conpot](http://conpot.org) - ICS/SCADA Honeypot
*	[Cowrie](https://github.com/micheloosterhof/cowrie) - SSH Honeypot
* [Dionaea](https://github.com/gento/dionaea) - 複数のWebアプリケーションを模倣
* [Elasticpot](https://hub.docker.com/r/honeynet/elasticpot/)- Elastic search
* [eMobility](https://github.com/dtag-dev-sec/emobility)
* [Glastopf](http://mushmush.org) - Webアプリケーションサーバ</li>
* [Honeytrap](https://github.com/dtag-dev-sec/honeytrap) - ネットワークサービスへの攻撃を検知

加えて、２つのツールが動いています。
* ELK - Elastic-search, Logstash, Kibana
* [Elasticserch Head](https://mobz.github.io/elasticsearch-head/) - Elasticserch GUI
* [Netdata](http://my-netdata.io/) - リアルタイムシステムモニタリング
* [Portainer](http://portainer.io/) - DockerをWebからいじる
* [Suricata](http://suricata-ids.org/features/) - オープンソースのIDS/IPS (侵入検知システム)
* [Wetty](https://github.com/krishnasrinivas/wetty) - WebベースのSSHクライアント

## 導入
isoからの方が楽で確実. 途中途中でyes/noを選択するところがあるので放置しすぎると止まってるので注意。

### isoイメージからブート
isoイメージ作成 or isoイメージDL - http://community-honeypot.de/tpot.iso
```
 git clone https://github.com/dtag-dev-sec/tpotce.git
 cd tpotce
 sudo ./makeiso.sh
```

[Rufus](https://rufus.akeo.ie/?locale=ja_JP)とか [unebootin](https://unetbootin.github.io/)などを使ってUSBブート。Rufusの方が速い感じがする。

GUI install
```
sudo apt-get update
sudo apt-get install ubuntu-desktop
sudo shutdown -r now
```

### Ubuntu16.04に直でインストール
既にUbuntu環境が用意されている場合(16.04.xのみで動作), EC2等を利用する場合

Ubuntu16.04のダウンロード -  [Ubuntu16.04.02](https://www.ubuntu.com/download/desktop/contribute?version=16.04.2&architecture=amd64)

```
git clone https://github.com/dtag-dev-sec/t-pot-autoinstall.git
cd t-pot-autoinstall/
sudo su
./install.sh
```
途中で止まると、途中までで生成したファイルとかが残ってるので面倒

## SSH設定
1. ローカルで鍵生成 - `ssh-keygen -t rsa`
2. 共通鍵共有 - `scp -P 64295 .ssh/tpot_id_rsa.pub tsec@ip:~/`
3. tpot側で登録
```
mkdir ~/.ssh
cat tpot_id_rsa.pub >> .ssh/authorized_keys
chmod 600 .ssh/authorized_keys
rm id_rsa.pub
```
4. ローカルで設定 - `~/.ssh/config`に追加
```
Host 'name'
  HostName Host IP or Domain
  IdentityFile ~/.ssh/tpot_id_rsa
  Port 12345
```
5. 接続 - `ssh ip` -> 鍵生成時のパスを入力すれば入れます。

## 接続
起動できたら、[localhost:64297](http://localhost:64297) に接続するとKibanaの画面が見れます。
別PCで見るには、sshポートフォワーディングを使います。

`ssh -D 8880 ip`

としてから、ip:64297 に繋げばいけます。

ハニーポットごとのアクセス統計やアクセス元IP・ログ等が見れ、ログもパラメータごとに絞り込み、ソートなどもできます。

こんな感じ
![tpot](/images/tpot2.png)

![tpot](/images/tpot1.png)

## まとめ
T-Potは構築は簡単でとっつきやすいわりに、高性能で良い。
マルウェアに感染したIoT機器からの感染を広げるためのアクセスを見れたりした。  

T-Potの拡張・ログからvirustotalにぶん投げたりしている.これらは別に書きたい。
