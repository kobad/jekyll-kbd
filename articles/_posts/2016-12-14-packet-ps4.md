---
layout: post
title: "PS4　パケットキャプチャ"
date: 2016-12-14 23:00:00 +0900
categories: network
thumb: /assets/images/packet.png
---

![packet](http://kobadlve.github.io/assets/images/packet.png)


会津クソ寒くて死にそうです。ガッキーを見て温まる。

ps4のオンラインゲームを対象にしてパケットを眺めてみました。（名前を出していいのかよくわからないw）

コンシューマゲームのパケットキャプチャ方法と眺めた結果を書きました。

一応パケットの詳細はあまり載せずに自分で見て感じたことという感じです。

気になる人は自分でキャプチャするかコンタクトくださいい。


## キャプチャ方法

いろいろ方法はあると思いますが、スイッチを使ってポートミラーリングしてキャプチャしました。

使ったスイッチは [NETGERA GS105E-200JPS](https://www.amazon.co.jp/NETGEAR-アンマネージプラススイッチ-ギガ5ポート-無償永久保証-GS105E-200JPS/dp/B00KEXR0GA/ref=pd_bxgy_14_img_3?_encoding=UTF8&psc=1&refRID=KV4QVHD3QP5H4MNZQWW6)
4000円くらい

※イメージ

![route](http://kobadlve.github.io/assets/images/route.png)

Prosafe Plusユーティリティソフトウェア(Windowsのみ)が提供されていて、GUIでも簡単にミラーリングの設定ができます。

この場合だと
02ポートとPS4を繋いで、

03ポートとPCを繋いで以下のように設定するとPS4に流れるパケットがPCにも流れてきます。

![gear](http://kobadlve.github.io/assets/images/netgear.png)

## キャプチャして眺める

３つのシチュエーションで考えました。

1. マッチ検索
2. 試合中
3. 試合終了

### 1. マッチ検索

* UDP
* TCP
* [SIP](https://ja.wikipedia.org/wiki/Session_Initiation_Protocol)
* [SDP](https://ja.wikipedia.org/wiki/Session_Description_Protocol)

マッチ検索時はまず、UDPで自分のユーザ情報をb○ttle.netに送るために確認応答みたいなことをしてるのが見れた。

Client: [0x6a, 0x61, 0x4b, 0x00] -> Server

Server: [0x00, 0x00, 0x00, 0x00] -> Client

Client: [0x6a, 0x61, 0x4b, 0x00] -> Server

Server: [0x00, 0x00, 0x00, 0x00] -> Client

と繰り返したのちに<b>SIP/SDP</b>でセッションを確立してユーザ情報を渡していた。

ps4であればアカウントは作成しなくても良いはずなので、ps4ユーザは自動的に作られているのかな


次に、Blizz○rdのサーバとTCP通信が行われます。

TLS1.2で証明書は[DigiCert](https://www.digicert.com/)のものを使われているのがわかった。

TCP通信では、<b>マッチで使うサーバとかを決めてるとか？</b>


その後、(上で決めたサーバと)UDP通信が始まり、まず自分のユーザ情報を送り、マッチに参加するユーザ名が返ってきて、参加者が共有されてるのが見えた。

そしてマッチ開始。

### 2. 試合中

* UDP
* RTP

Amazon EC2と通信していて、

ゲーム情報は全部UDP通信で進む。

RTPも流れていて、これは<b>ボイスチャットか何か？</b>

2つのBliz○rdサーバにそれぞれUDP、TCP通信を定期的にしていて、

UDPでは同じやり取りを定期的に繰り返していて、<b>何か(回線抜きとか)の確認とか？</b>

### 3. 試合終了

* TCP

TCP, TLS1.2 (DigiCert)

試合中とは別のAmazon EC2サーバ(スコアサーバ？)と通信して結果を受け取ってる。

このとき同時にマッチメイキングもしていて、次のマッチにスムーズに進むようにしていた。


## 終わり

本当に眺めただけですが、いろんな想像(どんな通信をして何を送ってるのか)ができて楽しい。

いずれはプラグイン書いたり、詳しく解析できるようになりたい。。。

スイッチも案外安いので、コンシューマのパケット取りたい人はかってみてはいかがでしょう。

にしても、Over Watchは神ゲーでクリスマスイベントもきたし、楽しみましょう！w

## 参考

* [https://www.wireshark.org/docs/:title]
* [https://fossies.org/linux/wireshark/manuf]
